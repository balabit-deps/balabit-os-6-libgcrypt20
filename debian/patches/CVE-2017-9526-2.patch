Backport of:

From 91456759b887e153c4d4ce19538d478df260cab2 Mon Sep 17 00:00:00 2001
From: NIIBE Yutaka <gniibe@fsij.org>
Date: Fri, 2 Jun 2017 10:34:42 +0900
Subject: [PATCH] secmem: Fix SEGV and stat calculation.

* src/secmem (init_pool): Care about the header size.
(_gcry_secmem_malloc_internal): Likewise.
(_gcry_secmem_malloc_internal): Use mb->size for stats.

--

GnuPG-bug-id: 3027
Signed-off-by: NIIBE Yutaka <gniibe@fsij.org>
---
 src/secmem.c | 10 +++++-----
 1 file changed, 5 insertions(+), 5 deletions(-)

Index: libgcrypt20-1.6.5/src/secmem.c
===================================================================
--- libgcrypt20-1.6.5.orig/src/secmem.c	2017-07-03 08:15:59.205490302 -0400
+++ libgcrypt20-1.6.5/src/secmem.c	2017-07-03 08:15:59.201490302 -0400
@@ -437,7 +437,7 @@ init_pool (size_t n)
 
   /* Initialize first memory block.  */
   mb = (memblock_t *) pool;
-  mb->size = pool_size;
+  mb->size = pool_size - BLOCK_HEAD_SIZE;
   mb->flags = 0;
 }
 
@@ -591,7 +591,7 @@ _gcry_secmem_malloc_internal (size_t siz
 
   mb = mb_get_new ((memblock_t *) pool, size);
   if (mb)
-    stats_update (size, 0);
+    stats_update (mb->size, 0);
 
   return mb ? &mb->aligned.c : NULL;
 }
